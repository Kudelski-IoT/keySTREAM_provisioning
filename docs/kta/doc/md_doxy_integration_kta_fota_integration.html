<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>keySTREAM Trusted Agent: FOTA Integration User Guide</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="kudelski.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="LOGO_IOT_IOTHINGS.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">keySTREAM Trusted Agent
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('md_doxy_integration_kta_fota_integration.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">FOTA Integration User Guide </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This guide provides a comprehensive overview of the Firmware Over-The-Air (FOTA) integration process using the keySTREAM Trusted Agent. It covers all essential steps, API details, storage requirements, and best practices to ensure secure, reliable, and maintainable FOTA operations for your product.</p>
<blockquote class="doxtable">
<p><b>Note:</b> FOTA integration and usage can be performed and evaluated only on the Trust Platform Design Suite (TPDS) application. Ensure you have the latest TPDS application installed, along with the keySTREAM Connect extension, to enable full FOTA functionality and testing.</p>
<p><b>Note:</b> Version is currently a free-form string of Max 16bytes.</p>
<p><b>Note:</b> Fota Agent can be used as it is or integrator can also re-write Fota as per there need. </p>
</blockquote>
<h1><a class="anchor" id="autotoc_md1"></a>
Overview</h1>
<p>Overview quick links:</p>
<ul>
<li><a href="#fota-overview">FOTA Overview</a></li>
<li><a href="#fota-sequence">FOTA Sequence</a></li>
<li><a href="#fota-modules">FOTA Modules</a></li>
<li><a href="#sal-fota-storage-requirements">FOTA Storage</a></li>
</ul>
<blockquote class="doxtable">
<p>Note: Implement <code><a class="el" href="fotaplatform_8c.html" title="Fota Installer.">fotaplatform.c</a></code> first, then validate using the sequence diagram. </p>
</blockquote>
<p><a class="anchor" id="fota-overview"></a> </p>
<h1><a class="anchor" id="autotoc_md2"></a>
FOTA Overview (keySTREAM &lt;-&gt; Device)</h1>
<p>This section summarizes how the keySTREAM ecosystem and the device (running the Trusted Agent / KTA) collaborate across the full firmware update lifecycle.</p>
<ol type="1">
<li>Firmware Preparation &amp; Packaging – Build, test, sign, encrypt the binary; generate component metadata (name, version, size, hash, signature).</li>
<li>Inventory &amp; Publication – Upload/package artifact into keySTREAM; it becomes visible in the firmware inventory/catalog.</li>
<li>Campaign Planning &amp; Targeting – Define the deployment campaign (target device group / criteria, rollout schedule).</li>
<li>Distribution / Download – Device (via Agent + Platform) retrieves download URL/metadata and downloads component payload(s) securely.</li>
<li>Installation &amp; Verification – Platform installs components, verifies integrity/signature, updates installed snapshot and reports progress.</li>
<li>Fleet Monitoring &amp; Compliance – keySTREAM tracks campaign status, per‑device success/error, and aggregate compliance; device reports final state &amp; versions.</li>
</ol>
<div class="image">
<img src="overall.png" alt=""/>
</div>
   <p><a class="anchor" id="fota-sequence"></a> </p>
<h1><a class="anchor" id="autotoc_md3"></a>
FOTA Sequence</h1>
<p>Below is the sequence diagram illustrating how the FOTA storage APIs are used, detailing the process flow and interactions for each API:</p>
<div class="image">
<img src="fota_workflow.png" alt=""/>
</div>
   <p><a class="anchor" id="fota-modules"></a> </p>
<h2><a class="anchor" id="autotoc_md4"></a>
FOTA Modules</h2>
<p>The FOTA system consists of three core modules that handle different aspects of the firmware update process:</p>
<h3><a class="anchor" id="autotoc_md5"></a>
1. FOTA Agent</h3>
<ul>
<li>(Agent implementation) – part of KTA package (can be reused or rewritten)<ul>
<li><b>Component Validation:</b> Validates firmware components received from the keySTREAM server, including component details and version verification</li>
<li><b>Metadata Management:</b> Stores campaign metadata and manages FOTA installation URLs</li>
<li><b>Status Monitoring:</b> Tracks installation progress and reports status updates to keySTREAM</li>
<li><b>Device Information:</b> Communicates installed component versions and device capabilities to keySTREAM server</li>
</ul>
</li>
</ul>
<h3><a class="anchor" id="autotoc_md6"></a>
2. FOTA Process</h3>
<ul>
<li>(Process logic) – provided; integrator may rewrite<ul>
<li><b>Version Comparison:</b> Compares server-provided component versions with locally installed versions</li>
<li><b>Campaign Management:</b> Stores and updates FOTA campaign information</li>
<li><b>Component Updates:</b> Manages the component update lifecycle and state transitions</li>
</ul>
</li>
</ul>
<h3><a class="anchor" id="autotoc_md7"></a>
3. FOTA Platform</h3>
<ul>
<li><p class="startli"><b>Integrator Implementation Required</b></p>
<p class="startli"><b>Required APIs:</b></p><ul>
<li><a href="#fotaPlatformGetComponents"><code>fotaPlatformGetComponents</code></a> – Return current installed component versions</li>
<li><a href="#fotaStartInstallation"><code>fotaStartInstallation</code></a> – download + install workflow</li>
<li>Persist campaign metadata, target component (name, version, URL)</li>
<li>Download, verify and install each component; call <a href="#fotaUpdateComponent"><code>fotaUpdateComponent</code></a> after each</li>
<li>Maintain resumable state across reset/power loss (state + target components + URL + metadata)</li>
<li>Provide accurate installed component list on request</li>
<li>Handle errors and partial progress gracefully (retry / leave state for resume)</li>
</ul>
<p class="startli"><b>Implementation Guidelines:</b></p>
<p class="startli"><a href="#fotaPlatformGetComponents"><code>fotaPlatformGetComponents</code></a></p><ul>
<li>If state = success/idle: load installed list and fill output array</li>
<li>If state = in_progress/error: return last known installed versions (pre-update) so agentcan reflect progress</li>
<li>Map result to status codes: success / error / in_progress</li>
</ul>
<p class="startli"><a href="#fotaStartInstallation"><code>fotaStartInstallation</code></a></p><ul>
<li>Validate inputs (metadata pointer/length, component list not NULL)</li>
<li>Persist metadata + target component list + URL(s) before starting work</li>
<li>Record state = in_progress, then create/start the install thread/task and return</li>
<li>Thread performs: per-component download -&gt; install -&gt; [<code>fotaUpdateComponent</code>(#fotaStartInstallation)</li>
<li>On completion: update state (success / error) and persist final installed versions</li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="autotoc_md8"></a>
API Details</h1>
<p><b>Source File:</b> <br  />
 </p><blockquote class="doxtable">
<p><code>Source Files\config\default\library\kta_lib\SOURCE\kta\modules\fotaservices\<a class="el" href="fotaplatform_8c.html" title="Fota Installer.">fotaplatform.c</a></code> </p>
</blockquote>
<p><a class="anchor" id="fotaPlatformGetComponents"></a> </p>
<h2><a class="anchor" id="autotoc_md9"></a>
1. fotaPlatformGetComponents()</h2>
<div class="fragment"><div class="line"><span class="comment">// Get currently installed component versions.</span></div>
<div class="line">TKFotaStatus <a class="code" href="fotaplatform_8c.html#a611b15a0c977443a16322a66a23535c9">fotaPlatformGetComponents</a>(TComponent *xpComponents);</div>
</div><!-- fragment --><p>Use: Agent calls this to check what is installed. Must: <code>xpComponents</code> not NULL; fill each entry (name + version). Returns:</p><ul>
<li><code>E_K_FOTA_SUCCESS</code> data filled</li>
<li><code>E_K_FOTA_IN_PROGRESS</code> update running (return last known installed set)</li>
<li><code>E_K_FOTA_ERROR</code> problem reading data</li>
</ul>
<hr  />
<p><a class="anchor" id="fotaStartInstallation"></a> </p>
<h2><a class="anchor" id="autotoc_md11"></a>
2. fotaStartInstallation()</h2>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> fotaStartInstallation(<span class="keyword">const</span> <span class="keywordtype">void</span> *xpFotaMetadata,</div>
<div class="line">                                        <span class="keywordtype">size_t</span> xFotaMetadataLen,</div>
<div class="line">                                        <span class="keyword">const</span> TTargetComponent *xpComponents);</div>
</div><!-- fragment --><p>Flow (typical):</p><ol type="1">
<li>Validate pointers / lengths.</li>
<li>Persist metadata + target component list (+ URLs) first.</li>
<li>Set state = in_progress.</li>
<li>Spawn install task/thread.</li>
<li>Worker: download -&gt; install -&gt; call <code><a class="el" href="fotaprocess_8c.html#aaf74514c84ad3f2286ad12f55e2007e2" title="implement fotaUpdateComponent">fotaUpdateComponent()</a></code> after each.</li>
</ol>
<p><a class="anchor" id="fotaUpdateComponent"></a> </p>
<h2><a class="anchor" id="autotoc_md12"></a>
3. fotaUpdateComponent()</h2>
<div class="fragment"><div class="line"><span class="comment">// Report per-component progress/state to agent.</span></div>
<div class="line">TKFotaStatus <a class="code" href="fotaprocess_8c.html#aaf74514c84ad3f2286ad12f55e2007e2">fotaUpdateComponent</a>(<span class="keyword">const</span> uint8_t *componentName,</div>
<div class="line">                                                 <span class="keywordtype">size_t</span> componentNameLen,</div>
<div class="line">                                                 <span class="keyword">const</span> uint8_t *componentVersion,</div>
<div class="line">                                                 <span class="keywordtype">size_t</span> componentVersionLen,</div>
<div class="line">                                                 <a class="code" href="fotaprocess_8h.html#a0dc923906125cbf02c78ba17293c13bc">TFotaState</a> state);</div>
</div><!-- fragment --><hr  />
<p><a class="anchor" id="sal-fota-storage-requirements"></a> </p>
<h2><a class="anchor" id="autotoc_md14"></a>
SAL FOTA Storage Requirements</h2>
<p>The platform must persist a small, well‑defined set of items so updates can resume after reset and the agent can always report an accurate state.</p>
<p><b>Storage Access APIs:</b></p><ul>
<li><code>salFotaStorageWrite()</code> (write / update) <br  />
</li>
<li><code>salFotaStorageRead()</code> (read / load)</li>
</ul>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Storage ID </th><th class="markdownTableHeadNone">Max Size </th><th class="markdownTableHeadNone">Contents / Format (Example) </th><th class="markdownTableHeadNone">Purpose / Usage  </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>FOTA_STORAGE_STATE_ID</code> </td><td class="markdownTableBodyNone">1 byte </td><td class="markdownTableBodyNone">State enum </td><td class="markdownTableBodyNone">Resume logic &amp; status reporting  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>FOTA_STORAGE_NAME_ID</code> </td><td class="markdownTableBodyNone">16 bytes </td><td class="markdownTableBodyNone">Device / platform name (ASCII) </td><td class="markdownTableBodyNone">Identification / optional reporting  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>FOTA_STORAGE_INSTALLED_COMPONENT_ID</code> </td><td class="markdownTableBodyNone">5 bytes </td><td class="markdownTableBodyNone">Packed current versions snapshot* </td><td class="markdownTableBodyNone">Baseline for comparison &amp; reporting  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>FOTA_STORAGE_TARGET_COMPONENT_ID</code> </td><td class="markdownTableBodyNone">5 bytes </td><td class="markdownTableBodyNone">Packed target versions snapshot* </td><td class="markdownTableBodyNone">Resume / retry campaign after interruption  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>FOTA_STORAGE_URL_ID</code> </td><td class="markdownTableBodyNone">Impl. defined </td><td class="markdownTableBodyNone">Last/active download URL </td><td class="markdownTableBodyNone">Retry without new campaign fetch  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>FOTA_STORAGE_METADATA_ID</code> </td><td class="markdownTableBodyNone">32 bytes </td><td class="markdownTableBodyNone">Campaign / firmware metadata blob </td><td class="markdownTableBodyNone">Identification &amp; integrity context  </td></tr>
</table>
<ul>
<li>Access (read / write) is performed through the [FOTA Storage API]</li>
</ul>
<h3><a class="anchor" id="autotoc_md15"></a>
Implementation Guidelines</h3>
<ol type="1">
<li>Persist: state, target components, URL and metadata before starting installation logic. <br  />
</li>
<li>Always write state first = <code>in_progress</code> before downloads begin. <br  />
</li>
<li>After each component success/failure, update installed snapshot (optional mid‑campaign) if power loss risk is high. <br  />
</li>
<li>On completion: atomically (or ordered) write installed snapshot then state = <code>success</code> or <code>error</code>. <br  />
</li>
<li>Validate reads (length, simple CRC or checksum) before using data; fall back to <code>idle</code> if invalid. <br  />
</li>
<li>Avoid excessive flash wear (batch writes, compare-before-write). <br  />
</li>
<li>Treat URL as volatile: overwrite only when campaign changes. <br  />
</li>
<li>Use defensive bounds checking when copying variable length version strings.</li>
</ol>
<blockquote class="doxtable">
<p><b>Version String Note:</b> Version is free‑form. Select a fixed internal maximum suited to your MCU (e.g. 8, 12, 16 bytes). Enforce truncation or rejection rules consistently when packing installed / target snapshots. </p>
</blockquote>
<h1><a class="anchor" id="autotoc_md16"></a>
API Details</h1>
<p><b>Files:</b> <br  />
 </p><blockquote class="doxtable">
<p>Source: <code>Source Files\config\default\library\kta_lib\SOURCE\salapi\k_sal_fotastorage.c</code> <br  />
 Header: <code>SOURCE\salapi\include\k_sal_fotastorage.h</code> </p>
</blockquote>
<p><b>Purpose:</b> MCU‑specific persistence layer for all FOTA state items (state enum, installed + target version snapshots, campaign metadata, download URL, device/name ID). Provides a simple keyed abstraction over flash / EEPROM / other NVM.</p>
<div class="fragment"><div class="line"> </div>
<div class="line"><span class="keywordtype">bool</span> salFotaStorageWrite(uint32_t xStorageDataId,</div>
<div class="line">                         <span class="keyword">const</span> uint8_t *xpData,</div>
<div class="line">                         <span class="keywordtype">size_t</span> xDataLen);</div>
</div><!-- fragment --><div class="fragment"><div class="line"> </div>
<div class="line"><span class="keywordtype">bool</span> salFotaStorageRead(uint32_t xStorageDataId,</div>
<div class="line">                        uint8_t *xpData,</div>
<div class="line">                        <span class="keywordtype">size_t</span> *xpDataLen);</div>
</div><!-- fragment --><p><b>Purpose:</b> MCU‑specific persistence layer for FOTA metadata, state, target + installed version snapshots, URL and campaign metadata.</p>
<h3><a class="anchor" id="autotoc_md17"></a>
Integration Notes</h3>
<ul>
<li>All listed items must be implemented for reliable FOTA behavior.</li>
<li>Persistent snapshots enable resume instead of full restart after failure.</li>
<li>Include minimal integrity verification (length + CRC) for each block.</li>
<li>Keep writes idempotent; avoid partial updates by ordering or staging.</li>
</ul>
<hr  />
<hr  />
<h1><a class="anchor" id="autotoc_md19"></a>
FOTA Integration Outcomes</h1>
<h2><a class="anchor" id="autotoc_md20"></a>
Success Case</h2>
<p>After successful integration and execution of the FOTA workflow, you will observe the following result:</p>
<div class="image">
<img src="sucess_fota.png" alt=""/>
</div>
   <ul>
<li>The firmware update completes successfully.</li>
<li>All components are updated and reported to keySTREAM.</li>
<li>Device state and component information are accurately reflected in persistent storage.</li>
</ul>
<h2><a class="anchor" id="autotoc_md21"></a>
Error Case</h2>
<p>If the firmware download or installation fails, the following process occurs:</p>
<div class="image">
<img src="fail_fota.png" alt=""/>
</div>
   <ul>
<li>keySTREAM will resend the update URL to the device for retrying the firmware update.</li>
<li>The application logic can choose to use the new URL provided by keySTREAM or the URL stored in persistent storage.</li>
<li>Error handling and recovery mechanisms should be implemented to ensure robust update management and minimize downtime. </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<div class="ttc" id="afotaprocess_8h_html_a0dc923906125cbf02c78ba17293c13bc"><div class="ttname"><a href="fotaprocess_8h.html#a0dc923906125cbf02c78ba17293c13bc">TFotaState</a></div><div class="ttdeci">TFotaState</div><div class="ttdoc">Interface for Fota processing.</div><div class="ttdef"><b>Definition:</b> fotaprocess.h:56</div></div>
<div class="ttc" id="afotaprocess_8c_html_aaf74514c84ad3f2286ad12f55e2007e2"><div class="ttname"><a href="fotaprocess_8c.html#aaf74514c84ad3f2286ad12f55e2007e2">fotaUpdateComponent</a></div><div class="ttdeci">TKFotaStatus fotaUpdateComponent(const uint8_t *componentName, const size_t componentNameLen, const uint8_t *componentVersion, const size_t componentVersionLen, TFotaState state)</div><div class="ttdoc">implement fotaUpdateComponent</div><div class="ttdef"><b>Definition:</b> fotaprocess.c:672</div></div>
<div class="ttc" id="afotaplatform_8c_html_a611b15a0c977443a16322a66a23535c9"><div class="ttname"><a href="fotaplatform_8c.html#a611b15a0c977443a16322a66a23535c9">fotaPlatformGetComponents</a></div><div class="ttdeci">TKFotaStatus fotaPlatformGetComponents(TComponent *xpComponents)</div><div class="ttdoc">Fota Platform.</div><div class="ttdef"><b>Definition:</b> fotaplatform.c:55</div></div>
<!-- HTML footer for doxygen 1.9.1-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer"><b></b>
    Copyright &copy; 2023-2024 Nagravision S&agrave;rl.
	- Generated by <a href="https://www.doxygen.org/index.html" target="_new">doxygen</a> 1.8.17</li>
  </ul>
</div>
</body>
</html>